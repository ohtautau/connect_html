<html lang='en'>
<head>
    <meta charset='UTF-8'>
    <link href="dist/main.css" rel="stylesheet"/>
</head>
<body>
<div>
    <form>
        <details
                class="w-full border border-brand-primary-main dark:border-dark-100 rounded-md cr-bg-tertiary cr-text-primary">
            <summary class="py-3 px-4 font-bold cr-text-secondary cursor-pointer">
                Instructions
            </summary>
            <div class="pb-3 px-4 ql-editor ql-display !min-h-0">
                {{ task.instructions ?? 'No instructions provided.'}}
            </div>
        </details>

        <!-- raw convo data (hidden) -->
        <div class="convo-id" style="display:none">{{ task.row_data['id1'] }}</div>
        <div class="convo-title-raw" style="display:none">{{ task.row_data['title1'] }}</div>
        <div class="convo-text-raw" style="display:none">{{ task.row_data['convo1'] }}</div>
        <div class="convo-id" style="display:none">{{ task.row_data['id2'] }}</div>
        <div class="convo-title-raw" style="display:none">{{ task.row_data['title2'] }}</div>
        <div class="convo-text-raw" style="display:none">{{ task.row_data['convo2'] }}</div>
        <div class="convo-id" style="display:none">{{ task.row_data['id3'] }}</div>
        <div class="convo-title-raw" style="display:none">{{ task.row_data['title3'] }}</div>
        <div class="convo-text-raw" style="display:none">{{ task.row_data['convo3'] }}</div>

        <!-- hidden answer inputs -->
        <input type="hidden" name="answer_convo1" id="answer_convo1" value="">
        <input type="hidden" name="answer_convo2" id="answer_convo2" value="">
        <input type="hidden" name="answer_convo3" id="answer_convo3" value="">

        <!-- progress -->
        <div style="height:6px; background:#e0e0e0; border-radius:3px; margin:12px 0; overflow:hidden;">
            <div id="progressFill" style="height:100%; background:#4a90d9; width:0%; transition:width .3s;"></div>
        </div>
        <div id="progressText" style="text-align:center; font-size:14px; color:#555;"></div>

        <!-- conversation display -->
        <div style="border:1px solid #d0d0d0; border-radius:8px; padding:20px; margin:16px 0; background:#fafafa;">
            <div id="convoTitle" style="font-size:16px; font-weight:bold; margin-bottom:12px; padding-bottom:8px; border-bottom:2px solid #4a90d9;"></div>
            <div id="convoBody" style="white-space:pre-wrap; line-height:1.7; font-size:14px; color:#333;"></div>
        </div>

        <!-- question -->
        <div style="margin:20px 0; padding:16px; background:#eef5fc; border-left:4px solid #4a90d9; border-radius:0 6px 6px 0;">
            <p style="font-weight:600; margin:0 0 12px 0;">Does this conversation contain any issues?</p>
            <label style="margin-right:24px;"><input type="radio" name="currentAnswer" value="Yes"> Yes</label>
            <label><input type="radio" name="currentAnswer" value="No"> No</label>
        </div>

        <!-- navigation -->
        <div style="display:flex; justify-content:space-between; align-items:center; margin:24px 0;">
            <button type="button" id="prevBtn" onclick="go(-1)" style="padding:10px 28px; border:none; border-radius:6px; font-size:14px; font-weight:600; cursor:pointer; color:#fff; background:#6c757d;">&#8592; Previous</button>
            <span id="pageNum" style="font-size:14px; color:#555;"></span>
            <button type="button" id="nextBtn" onclick="go(1)" style="padding:10px 28px; border:none; border-radius:6px; font-size:14px; font-weight:600; cursor:pointer; color:#fff; background:#4a90d9;">Next &#8594;</button>
        </div>

        <!-- submit -->
        <div id="submitRow" style="text-align:center; margin:20px 0; display:none;">
            <button type="submit" id="submitBtn" disabled style="padding:12px 48px; font-size:15px; font-weight:600; border:none; border-radius:6px; background:#28a745; color:#fff; cursor:pointer;">Submit</button>
        </div>
    </form>
</div>

<script>
(function () {
    /* ---- collect convo data from hidden divs ---- */
    var ids    = document.querySelectorAll('.convo-id');
    var titles = document.querySelectorAll('.convo-title-raw');
    var texts  = document.querySelectorAll('.convo-text-raw');
    var convos = [];
    for (var i = 0; i < texts.length; i++) {
        var t = texts[i].textContent.trim();
        if (!t) continue;
        convos.push({
            id:    ids[i] ? ids[i].textContent.trim() : '',
            title: titles[i] ? titles[i].textContent.trim() : '',
            convo: t
        });
    }
    var total = convos.length;
    if (total === 0) return;
    var cur = 0;
    var radios = document.querySelectorAll('input[name="currentAnswer"]');

    function getAnswer(idx) {
        var el = document.getElementById('answer_convo' + (idx + 1));
        return el ? el.value : '';
    }
    function setAnswer(idx, val) {
        var el = document.getElementById('answer_convo' + (idx + 1));
        if (el) el.value = val;
    }
    function countAnswered() {
        var n = 0;
        for (var k = 0; k < total; k++) { if (getAnswer(k)) n++; }
        return n;
    }
    function saveCurrent() {
        for (var j = 0; j < radios.length; j++) {
            if (radios[j].checked) { setAnswer(cur, radios[j].value); return; }
        }
    }
    function render() {
        var c = convos[cur];
        document.getElementById('convoTitle').textContent = c.title || 'Conversation ' + (cur + 1);
        document.getElementById('convoBody').textContent  = c.convo || '';

        var saved = getAnswer(cur);
        for (var j = 0; j < radios.length; j++) {
            radios[j].checked = (radios[j].value === saved);
        }

        document.getElementById('prevBtn').disabled = (cur === 0);
        var isLast = (cur === total - 1);
        document.getElementById('nextBtn').style.display = isLast ? 'none' : '';
        document.getElementById('submitRow').style.display = isLast ? '' : 'none';

        var answered = countAnswered();
        document.getElementById('progressFill').style.width = (answered / total * 100) + '%';
        document.getElementById('progressText').textContent = 'Answered ' + answered + ' / ' + total;
        document.getElementById('pageNum').textContent = (cur + 1) + ' / ' + total;
        document.getElementById('submitBtn').disabled = (answered < total);
    }

    for (var r = 0; r < radios.length; r++) {
        radios[r].addEventListener('change', function () {
            saveCurrent();
            var answered = countAnswered();
            document.getElementById('progressFill').style.width = (answered / total * 100) + '%';
            document.getElementById('progressText').textContent = 'Answered ' + answered + ' / ' + total;
            document.getElementById('submitBtn').disabled = (answered < total);
        });
    }

    window.go = function (dir) {
        saveCurrent();
        var next = cur + dir;
        if (next < 0 || next >= total) return;
        cur = next;
        render();
        window.scrollTo(0, 0);
    };

    render();
})();
</script>
</body>
</html>